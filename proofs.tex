\chapter{Metatheory and Type Preservation} \label{ch:proofs}

In this chapter, I elaborate on the proofs of the lemmas and theorems listed in \cref{sec:syntactic-model},
culminating in type preservation, which by \cref{thm:consistency} proves the consistency of \lang.
Prior to these proofs, I provide the required metatheoretical properties of both \lang and \CICE.

\section{Metatheory of \lang}

\subsection{Basic properties}

We begin with three basic properties that all judgements satisfy:
\emph{weakening}\index{weakening}, which allows environments to be extended;
\emph{replacement}\index{replacement}, which allows replacing assumptions by subtypes
and definitions by reductions in the environment;
and \emph{substitutivity}\index{substitutivity}, which allows the subsitution of an assumption by a well-typed term
or a size variable by a size expression.
Because term environments have definitions in addition to assumptions,
substitutivity can only apply to variables that aren't already defined in the environment.

\begin{lemma}[Weakening] \label{lem:weakening}
Let $\Phi$ be a size environment,
let $\Gamma$ and $\Gamma'$ be term environments
where $\Gamma'$ does not shadow any variables of $\Gamma$,
and suppose $\wf{\Phi}{\Gamma, \Gamma'}$.
\begin{enumerate}[noitemsep]
  \item \label{item:weakening:red} If $\red{\Phi; \Gamma}{e_1}{e_2}$ then $\red{\Phi; \Gamma, \Gamma'}{e_1}{e_2}$.
  \item \label{item:weakening:red*} If $\red*{\Phi; \Gamma}{e_1}{e_2}$ then $\red*{\Phi; \Gamma, \Gamma'}{e_1}{e_2}$.
  \item \label{item:weakening:subtype} If $\subtype{\Phi; \Gamma}{\tau_1}{\tau_2}$ then $\subtype{\Phi; \Gamma, \Gamma'}{\tau_1}{\tau_2}$.
  \item If $\type{\Phi; \Gamma}{e}{\tau}$ then $\type{\Phi; \Gamma, \Gamma'}{e}{\tau}$.
\end{enumerate}
\end{lemma}

\begin{proof} \hfill
\begin{enumerate}[noitemsep]
  \item Trivial by cases on the derivation of $\red{\Phi; \Gamma}{e_1}{e_2}$.
  \item By induction on the derivation of $\red*{\Phi; \Gamma}{e_1}{e_2}$,
    using \cref{item:weakening:red} in \rref{red*-trans}.
  \item Trivial by \cref{item:weakening:red*} in \rref{subtype-red}.
  \item By induction on the derivation of $\type{\Phi; \Gamma}{e}{\tau}$,
    using \cref{item:weakening:subtype} in \rref{conv}. \qedhere
\end{enumerate}
\end{proof}

\begin{lemma}[Replacement by subtyping] \label{lem:replacement-subtyping}
Suppose $\subtype{\Phi; \Gamma_1}{\sigma_1}{\sigma_2}$ where
$\type{\Phi; \Gamma_1}{\sigma_1}{U}$ and $\type{\Phi; \Gamma_1}{\sigma_2}{U}$
for some $U$.
\begin{enumerate}[noitemsep]
  \item \label{item:replacement-subtyping:red}
    If $\red{\Phi; \Gamma_1, \annot{x}{\sigma_2}, \Gamma_2}{e_1}{e_2}$
    then $\red{\Phi; \Gamma_1, \annot{x}{\sigma_1}, \Gamma_2}{e_1}{e_2}$.
  \item \label{item:replacement-subtyping:red*}
    If $\red*{\Phi; \Gamma_1, \annot{x}{\sigma_2}, \Gamma_2}{e_1}{e_2}$
    then $\red*{\Phi; \Gamma_1, \annot{x}{\sigma_1}, \Gamma_2}{e_1}{e_2}$.
  \item \label{item:replacement-subtyping:subtyping}
    If $\subtype{\Phi; \Gamma_1, \annot{x}{\sigma_2}, \Gamma_2}{\tau_1}{\tau_2}$
    then $\subtype{\Phi; \Gamma_1, \annot{x}{\sigma_1}, \Gamma_2}{\tau_1}{\tau_2}$.
  \item
    \begin{enumerate}[noitemsep]
      \item \label{item:replacement-subtyping:typing} If $\type{\Phi; \Gamma_1, \annot{x}{\sigma_2}, \Gamma_2}{e}{\tau}$
        then $\type{\Phi; \Gamma_1, \annot{x}{\sigma_1}, \Gamma_2}{e}{\tau}$.
      \item \label{item:replacement-subtyping:wf} If $\wf{\Phi}{\Gamma_1, \annot{x}{\sigma_2}, \Gamma_2}$
        then $\wf{\Phi}{\Gamma_1, \annot{x}{\sigma_1}, \Gamma_2}$.
    \end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
  For \crefrange{item:replacement-subtyping:red}{item:replacement-subtyping:subtyping},
  the proof structure is similar to that of \nameref{lem:weakening}.
  \begin{enumerate}[noitemsep] \setcounter{enumi}{3}
    \item By mutual induction on the derivations of
      $\type{\Phi; \Gamma_1, \annot{x}{\sigma_2}, \Gamma_2}{e}{\tau}$ and
      $\wf{\Phi}{\Gamma_1, \annot{x}{\sigma_2}, \Gamma_2}$.
      % For \rref{cons-ass}, if the variable is $x$ (\ie if $\Gamma_2 = \mt$), use $\type{\Phi; \Gamma_1}{\sigma_1}{U}$.
      For \rref{var}, if the variable is $x$, apply \rref{conv}:
      \begin{mathpar}
      \inferrule{
        \type{\Phi; \Gamma_1}{\sigma_1}{U} \\
        \type{\Phi; \Gamma_1}{\sigma_2}{U} \\
        \type{\Phi; \Gamma_1, \annot{x}{\sigma_1}, \Gamma_2}{x}{\sigma_1} \\
        \subtype{\Phi; \Gamma_1}{\sigma_1}{\sigma_2}
      }{
        \type{\Phi; \Gamma_1, \annot{x}{\sigma_1}, \Gamma_2}{x}{\sigma_2}
      }
      \end{mathpar}
  \end{enumerate}
\end{proof}

\begin{corollary}
\nameref{lem:replacement-subtyping} also applies when the environment contains
$\define{x}{\sigma_2}{e'}$ rather than $\annot{x}{\sigma_2}$
by the exact same arguments.
\end{corollary}

\begin{lemma}[Replacement by reduction] \label{lem:replacement-reduction}
Suppose $\red*{\Gamma_1}{e_1}{e_2}$.
\begin{enumerate}[noitemsep]
  \item If $\subtype{\Phi; \Gamma_1, \define{x}{\sigma}{e_1}, \Gamma_2}{\tau_1}{\tau_2}$
    then $\subtype{\Phi; \Gamma_1, \define{x}{\sigma}{e_2}, \Gamma_2}{\tau_1}{\tau_2}$.
  \item If $\type{\Phi; \Gamma_1, \define{x}{\sigma}{e_1}, \Gamma_2}{e}{\tau}$
    then $\type{\Phi; \Gamma_1, \define{x}{\sigma}{e_2}, \Gamma_2}{e}{\tau}$.
\end{enumerate}
\end{lemma}

\begin{proof}
\TODO: Ask William
\end{proof}

\begin{lemma}[Substitutivity by terms] \label{lem:substitutivity-terms}
Suppose $\type{\Phi; \Gamma_1}{e}{\sigma}$.
\begin{enumerate}[noitemsep]
  \item If $\red{\Phi; \Gamma_1, \annot{x}{\sigma}, \Gamma_2}{e_1}{e_2}$
    then $\red{\Phi; \Gamma_1, \subst{\Gamma_2}{x}{e}}{\subst{e_1}{x}{e}}{\subst{e_2}{x}{e}}$
  \item If $\red*{\Phi; \Gamma_1, \annot{x}{\sigma}, \Gamma_2}{e_1}{e_2}$
  then $\red*{\Phi; \Gamma_1, \subst{\Gamma_2}{x}{e}}{\subst{e_1}{x}{e}}{\subst{e_2}{x}{e}}$
  \item If $\subtype{\Phi; \Gamma_1, \annot{x}{\sigma}, \Gamma_2}{\tau_1}{\tau_2}$
    then $\subtype{\Phi; \Gamma_1, \subst{\Gamma_2}{x}{e}}{\subst{\tau_1}{x}{e}}{\subst{\tau_2}{x}{e}}$
  \item \label{item:substitutivity:typing-wf}
    \begin{enumerate}[noitemsep]
      \item \label{item:substitutivity:typing} If $\type{\Phi; \Gamma_1, \annot{x}{\sigma}, \Gamma_2}{e'}{\tau}$
        then $\type{\Phi; \Gamma_1, \subst{\Gamma_2}{x}{e}}{\subst{e'}{x}{e}}{\subst{\tau}{x}{e}}$
      \item \label{item:substitutivity:wf} If $\wf{\Phi}{\Gamma_1, \annot{x}{\sigma}, \Gamma_2}$
        then $\wf{\Phi}{\Gamma_1, \subst{\Gamma_2}{x}{e}}$.
    \end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
The proof structure is similar to that of \nameref{lem:replacement-subtyping}.
For \rref{var} of \cref{item:substitutivity:typing}, if the variable is $x$,
apply \nameref{lem:weakening} to $\type{\Gamma_1}{e}{\sigma}$
using the extended environment from \cref{item:substitutivity:wf}.
\end{proof}

\begin{corollary}
\nameref{lem:substitutivity-terms} also applies when the environment contains $\define{x}{\sigma}{e}$
rather than $\annot{x}{\sigma}$ by the exact same arguments.
Note that the term being substituted in must be the one defined as $x$.
\end{corollary}

\begin{lemma}[Substitutivity by unbounded sizes] \label{lem:substitutivity-unbounded}
Suppose $\wf{\Phi_1}{s}$.
\begin{enumerate}[noitemsep]
  \item \label{item:substitutivity:unbounded:red}
    If $\red{\Phi_1, \alpha, \Phi_2; \Gamma}{e_1}{e_2}$
    then $\red{\Phi_1, \subst{\Phi_2}{\alpha}{s}; \subst{\Gamma}{\alpha}{s}}{\subst{e_1}{\alpha}{s}}{\subst{e_2}{\alpha}{s}}$.
  \item \label{item:substitutivity:unbounded:red*}
    If $\red*{\Phi_1, \alpha, \Phi_2; \Gamma}{e_1}{e_2}$
    then $\red*{\Phi_1, \subst{\Phi_2}{\alpha}{s}; \subst{\Gamma}{\alpha}{s}}{\subst{e_1}{\alpha}{s}}{\subst{e_2}{\alpha}{s}}$.
  \item \label{item:substitutivity:unbounded:subtyping}
    If $\subtype{\Phi_1, \alpha, \Phi_2; \Gamma}{\tau_1}{\tau_2}$
    then $\subtype{\Phi_1, \subst{\Phi_2}{\alpha}{s}; \subst{\Gamma}{\alpha}{s}}{\subst{\tau_1}{\alpha}{s}}{\subst{\tau_2}{\alpha}{s}}$.
  \item \label{item:substitutivity:unbounded:sizing}
    \begin{enumerate}[noitemsep]
      \item If $\wf{\Phi_1, \alpha, \Phi_2}{r}$
        then $\wf{\Phi_1, \subst{\Phi_2}{\alpha}{s}}{\subst{r}{\alpha}{s}}$.
      \item If $\wf{}{\Phi_1, \alpha, \Phi_2}$
        then $\wf{}{\Phi_1, \subst{\Phi_2}{\alpha}{s}}$.
    \end{enumerate}
  \item \label{item:substitutivity:unbounded:subsizing}
    If $\subsize{\Phi_1, \alpha, \Phi_2}{s_1}{s_2}$
    then $\subsize{\Phi_1, \subst{\Phi_2}{\alpha}{s}}{\subst{s_1}{\alpha}{s}}{\subst{s_2}{\alpha}{s}}$.
  \item
    \begin{enumerate}[noitemsep]
      \item If $\type{\Phi_1, \alpha, \Phi_2; \Gamma}{e}{\tau}$
        then $\type{\Phi_1, \subst{\Phi_2}{\alpha}{s}; \subst{\Gamma}{\alpha}{s}}{\subst{e}{\alpha}{s}}{\subst{\tau}{\alpha}{s}}$.
      \item If $\wf{\Phi_1, \alpha, \Phi_2}{\Gamma}$ then $\wf{\Phi_1, \subst{\Phi_2}{\alpha}{s}}{\subst{\Gamma}{\alpha}{s}}$
    \end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
For \crefrange{item:substitutivity:unbounded:red}{item:substitutivity:unbounded:subtyping},
the proof structure is similar to that of \nameref{lem:substitutivity-terms}.
\begin{enumerate}[noitemsep] \setcounter{enumi}{3}
  \item By mutual induction on the derivations of $\wf{\Phi_1, \alpha, \Phi_2}{r}$ and $\wf{}{\Phi_1, \alpha, \Phi_2}$.
    If $r = \alpha$ (\ie $\Phi_2 = \mt$) and $\alpha \in \Phi_1$, use $\wf{\Phi_1}{s}$.
  \item By induction on the derivation of $\subsize{\Phi_1, \alpha, \Phi_2}{s_1}{s_2}$,
    using \cref{item:substitutivity:unbounded:sizing}.
  \item By mutual induction on the derivations of $\type{\Phi_1, \alpha, \Phi_2; \Gamma}{e}{\tau}$
    and $\wf{\Phi_1, \alpha, \Phi_2}{\Gamma}$,
    using \cref{item:substitutivity:unbounded:subtyping} in \rref{conv},
    \cref{item:substitutivity:unbounded:sizing} in \rref{sapp, forall<, slam<},
    and \cref{item:substitutivity:unbounded:subsizing} in \rref{sapp<}.
    \qedhere
\end{enumerate}
\end{proof}

\begin{lemma}[Substitutivity by bounded sizes] \label{lem:substitutivity-bounded}
Suppose $\subsize{\Phi_1}{\sss{r}_1}{r_2}$.
\begin{enumerate}[noitemsep]
  \item \label{item:substitutivity:bounded:red}
    If $\red{\Phi_1, \bound{\alpha}{r_2}, \Phi_2; \Gamma}{e_1}{e_2}$ \\
    then $\red{\Phi_1, \subst{\Phi_2}{\alpha}{r_1}; \subst{\Gamma}{\alpha}{r_1}}{\subst{e_1}{\alpha}{r_1}}{\subst{e_2}{\alpha}{r_1}}$.
  \item \label{item:substitutivity:bounded:red*}
    If $\red*{\Phi_1, \bound{\alpha}{r_2}, \Phi_2; \Gamma}{e_1}{e_2}$ \\
    then $\red*{\Phi_1, \subst{\Phi_2}{\alpha}{r_1}; \subst{\Gamma}{\alpha}{r_1}}{\subst{e_1}{\alpha}{r_1}}{\subst{e_2}{\alpha}{r_1}}$.
  \item \label{item:substitutivity:bounded:subtyping}
    If $\subtype{\Phi_1, \bound{\alpha}{r_2}, \Phi_2; \Gamma}{\tau_1}{\tau_2}$ \\
    then $\subtype{\Phi_1, \subst{\Phi_2}{\alpha}{r_1}; \subst{\Gamma}{\alpha}{r_1}}{\subst{\tau_1}{\alpha}{r_1}}{\subst{\tau_2}{\alpha}{r_1}}$.
  \item \label{item:substitutivity:bounded:sizing}
    \begin{enumerate}[noitemsep]
      \item If $\wf{\Phi_1, \bound{\alpha}{r_2}, \Phi_2}{s}$
        then $\wf{\Phi_1, \subst{\Phi_2}{\alpha}{r_1}}{\subst{s}{\alpha}{r_1}}$.
      \item If $\wf{}{\Phi_1, \bound{\alpha}{r_2}, \Phi_2}$
        then $\wf{}{\Phi_1, \subst{\Phi_2}{\alpha}{r_1}}$.
    \end{enumerate}
  \item \label{item:substitutivity:bounded:subsizing}
    If $\subsize{\Phi_1, \bound{\alpha}{r_2}, \Phi_2}{s_1}{s_2}$
    then $\subsize{\Phi_1, \subst{\Phi_2}{\alpha}{r_1}}{\subst{s_1}{\alpha}{r_1}}{\subst{s_2}{\alpha}{r_1}}$.
  \item
    \begin{enumerate}[noitemsep]
      \item If $\type{\Phi_1, \bound{\alpha}{r_2}, \Phi_2; \Gamma}{e}{\tau}$ \\
        then $\type{\Phi_1, \subst{\Phi_2}{\alpha}{r_1}; \subst{\Gamma}{\alpha}{r_1}}{\subst{e}{\alpha}{r_1}}{\subst{\tau}{\alpha}{r_1}}$.
      \item If $\wf{\Phi_1, \bound{\alpha}{r_2}, \Phi_2}{\Gamma}$ then $\wf{\Phi_1, \subst{\Phi_2}{\alpha}{r_1}}{\subst{\Gamma}{\alpha}{r_1}}$
    \end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
The proof structure is similar to that of \nameref{lem:substitutivity-unbounded}.
For \cref{item:substitutivity:bounded:subsizing},
if $\alpha = r_1$ and $s_2 = r_2$ (\ie $\Phi_2 = \mt$),
use $\subsize{\Phi_1}{\sss{r}_1}{r_2}$.
\end{proof}

From here onwards, because it's used so often in uninteresting ways,
I omit explicit references to uses of weakening.

\subsection{Confluence}

\TODO

\begin{theorem}[Confluence] \label{thm:confluence}
If $\red*{\Phi; \Gamma}{e}{e_1}$ and $\red*{\Phi; \Gamma}{e}{e_2}$
then there is some term $e'$ such that
$\red*{\Phi; \Gamma}{e_1}{e'}$ and $\red*{\Phi; \Gamma}{e_2}{e'}$.
\end{theorem}

\begin{proof}
\TODO
\end{proof}

\subsection{Inversion}

\emph{Inversion principles}\index{inversion principle}
allow for deducing from a typing judgement the necessary premises for a typing derivation,
with one principle for each syntactic form.
In the presence of subtyping, these principles are a little more complex,
relating the type derived from the premises to the desired type by a subtyping judgement.
For concision, I prove all inversion principles for a general typing rule
rather than handling each rule explicitly.

Before we can prove the inversion principles,
we need transitivity of the subtyping judgement,
which in turn requires both confluence and transitivity of $\alpha$-cumulativity\index{$\alpha$-cumulativity}.

\begin{lemma}[Transitivity of $\alpha$-cumulativity] \label{lem:transitivity-acum}
If $\acum{e_1}{e_2}$ and $\acum{e_2}{e_3}$ then $\acum{e_1}{e_3}$.
\end{lemma}

\begin{proof}
By nested induction on the derivations of $\acum{e_1}{e_2}$ and $\acum{e_2}{e_3}$.
\begin{enumerate}[noitemsep, label=\textbf{Cases}, leftmargin=*, labelindent=\parindent]
  \item \rref*{acum-refl} and $\mathcal{R}$, $\mathcal{R}$ and \rref*{acum-refl}.
    Trivial by the $\mathcal{R}$ derivation.
  \item \rref*{acum-prop} and \rref*{acum-type}, \rref*{acum-type} and \rref*{acum-type}.
    Trivial by \rref*{acum-prop} or \rref*{acum-type} respectively.
  \item \rref*{acum-pi} and \rref*{acum-pi}, \rref*{acum-forall} and \rref*{acum-forall}, \rref*{acum-forall<} and \rref*{acum-forall<}.
    By \rref*{acum-pi}, \rref*{acum-forall}, or \rref*{acum-forall<}, respectively,
    using the induction hypothesis as premise. \qedhere
\end{enumerate}
\end{proof}

\begin{lemma}[Confluence up to $\alpha$-cumulativity] \label{lem:confluence-acum}
If $\acum{e_1}{e_2}$ and $\red*{\Phi; \Gamma}{e_1}{e'_1}$ then there is some term $e'_2$ such that
$\red*{\Phi; \Gamma}{e_2}{e'_2}$ and $\acum{e'_1}{e'_2}$.
\end{lemma}

\begin{proof}
By induction on the derivation of $\acum{e_1}{e_2}$.
\begin{enumerate}[noitemsep, label=\textbf{Case}, leftmargin=*, labelindent=\parindent]
  \item \rref*{acum-refl}. Trivial by \rref*{acum-refl} with the same reduction judgement.
  \item[\textbf{Cases}] \rref*{acum-prop}, \rref*{acum-type}. Since $\Prop$ and $\Type{}$ can't reduce any further,
    trivial by \rref*{acum-prop} or \rref*{acum-type} respectively with \cref{red*-refl}.
  \item \rref*{acum-pi}. \vspace{-\baselineskip}
    \begin{mathpar}
      \inferrule{
        \acum{\tau_1}{\tau_2}
      }{
        \acum{\funtype{x}{\sigma}{\tau_1}}{\funtype{x}{\sigma}{\tau_2}}
      }
    \end{mathpar}
    By inversion on the closure of reduction, we have
    $\red*{\Phi; \Gamma}{\funtype{x}{\sigma}{\tau_1}}{\funtype{x}{\sigma'}{\tau'_1}}$.
    where $\red*{\Phi; \Gamma}{\sigma}{\sigma'}$ and $\red*{\Phi; \Gamma, \annot{x}{\sigma'}}{\tau_1}{\tau'_1}$.
    By the induction hypothesis, we can conclude that there is some term $\tau'_2$ such that
    $\red*{\Phi; \Gamma, \annot{x}{\sigma'}}{\tau_2}{\tau'_2}$ and $\acum{\tau'_1}{\tau'_2}$.
    Then by \rref{red*-cong} we conclude that $\red*{\Phi; \Gamma}{\funtype{x}{\sigma}{\tau_2}}{\funtype{x}{\sigma'}{\tau'_2}}$,
    and by \rref{acum-pi} that $\acum{\funtype{x}{\sigma'}{\tau'_1}}{\funtype{x}{\sigma'}{\tau'_2}}$.
  \item \rref*{acum-forall}, \rref*{acum-forall<}. Similar to the case for \rref*{acum-pi}. \qedhere
\end{enumerate}
\end{proof}

\begin{corollary}[Confluence up to $\alpha$-cumulativity]
If $\acum{e_1}{e_2}$ and $\red*{\Phi; \Gamma}{e_2}{e'_2}$ then there is some $e'_1$ such that
$\red*{\Phi; \Gamma}{e_1}{e'_1}$ and $\acum{e'_1}{e'_2}$,
using the symmetric argument to \cref{lem:confluence-acum}.
\end{corollary}

\begin{theorem}[Transitivity of subtyping] \label{thm:transivity-subtyping}
If $\subtype{\Phi; \Gamma}{\tau_1}{\tau_2}$ and $\subtype{\Phi; \Gamma}{\tau_2}{\tau_3}$
then $\subtype{\Phi; \Gamma}{\tau_1}{\tau_3}$.
\end{theorem}

\begin{proof}
By cases on the derivations of $\subtype{\Phi; \Gamma}{\tau_1}{\tau_2}$
and $\subtype{\Phi; \Gamma}{\tau_2}{\tau_3}$.
\begin{mathpar}
\inferrule{
  \acum{\sigma_1}{\sigma_{21}} \\\\
  \red*{\Phi; \Gamma}{\tau_1}{\sigma_1} \\
  \red*{\Phi; \Gamma}{\tau_2}{\sigma_{21}}
}{
  \subtype{\Phi; \Gamma}{\tau_1}{\tau_2}
}
\and
\inferrule{
  \acum{\sigma_{22}}{\sigma_3} \\\\
  \red*{\Phi; \Gamma}{\tau_2}{\sigma_{22}} \\
  \red*{\Phi; \Gamma}{\tau_3}{\sigma_3}
}{
  \subtype{\Phi; \Gamma}{\tau_2}{\tau_3}
}
\end{mathpar}
By \nameref{thm:confluence}, there is some term $\tau'_2$ such that
\begin{itemize}[noitemsep]
  \item $\red*{\Phi; \Gamma}{\sigma_{21}}{\tau'_2}$ and
  \item $\red*{\Phi; \Gamma}{\sigma_{22}}{\tau'_2}$.
\end{itemize}
By \nameref{lem:confluence-acum}, there are terms $\tau'_1$ and $\tau'_3$ such that
\begin{itemize}[noitemsep]
  \item $\red*{\Phi; \Gamma}{\sigma_1}{\tau'_1}$,
  \item $\acum{\tau'_1}{\tau'_2}$; and
  \item $\red*{\Phi; \Gamma}{\sigma_3}{\tau'_3}$,
  \item $\acum{\tau'_2}{\tau'_3}$.
\end{itemize}
By \rref{red*-trans} and \nameref{lem:transitivity-acum}, we have
\begin{itemize}[noitemsep]
  \item $\red*{\Phi; \Gamma}{\tau_1}{\tau'_1}$,
  \item $\red*{\Phi; \Gamma}{\tau_3}{\tau'_3}$, and
  \item $\acum{\tau'_1}{\tau'_3}$.
\end{itemize}
Then finally by \rref{subtype-red}, we have $\subtype{\Phi; \Gamma}{\tau_1}{\tau_3}$.
\end{proof}

\begin{figure}[h]
\centering
\begin{tikzcd}
\tau_1
  \arrow[rr, dotted, no head, "{\mathlarger\preccurlyeq}" description]
  % \arrow[dd, dashrightarrow, bend right]
  \arrow[d, dashrightarrow]
&&\tau_2
  \arrow[rr, dotted, no head, "\mathlarger\preccurlyeq" description]
  \arrow[dl, dashrightarrow]
  \arrow[dr, dashrightarrow]
&&\tau_3
  % \arrow[dd, dashrightarrow, bend left]
  \arrow[d, dashrightarrow] \\
\sigma_1
  \arrow[r, dotted, no head, "\sqsubseteq" description]
  \arrow[d, dashrightarrow]
&\sigma_{21}
  \arrow[dr, dashrightarrow]
&&\sigma_{22}
  \arrow[r, dotted, no head, "\sqsubseteq" description]
  \arrow[dl, dashrightarrow]
&\sigma_3
  \arrow[d, dashrightarrow] \\
\tau'_1
  \arrow[rr, dotted, no head, "\sqsubseteq" description]
  % \arrow[rrrr, dotted, no head, bend right, "\sqsubseteq" description]
&&\tau'_2
  \arrow[rr, dotted, no head, "\sqsubseteq" description]
&&\tau'_3
\end{tikzcd}
\caption{Diagram of proof of \nameref{thm:transivity-subtyping}.}
\label{fig:transitivity-subtyping}
\end{figure}

A diagram representing the proof is shown in \cref{fig:transitivity-subtyping},
where the dashed arrows represent closure of reduction $\rhd^*$.

\begin{theorem}[Inversion] \label{thm:inversion}
Given a syntactic form $e$ and a typing rule $\mathcal{R} \neq \text{\upshape \rref*{conv*}}$ for that form,
if $\mathcal{D}$ is a derivation ending in $\type{\Gamma}{e}{\tau}$
and $\mathcal{J}_i$ are the judgement forms in the premises of $\mathcal{R}$,
then there exist derivations $\mathcal{D}_i$ ending in $\mathcal{J}_i$
such that $\mathcal{R}$ builds a derivation ending in $\type{\Gamma}{e}{\sigma}$,
and $\subtype{\Gamma}{\sigma}{\tau}$ holds.
\end{theorem}

\begin{proof}
By induction on the derivation of $\type{\Gamma}{e}{\tau}$.
\begin{itemize}[noitemsep, label=\textbf{Case}, leftmargin=*, labelindent=\parindent]
  \item $\mathcal{R}$. The premises of the derivation are the desired ones,
    building a derivation ending in $\type{\Gamma}{e}{\tau}$,
    and $\subtype{\Gamma}{\tau}{\tau}$ holds by
    \rref{subtype-conv, acum-refl, red*-refl}.
  \item \rref*{conv*}.
    \vspace{-\baselineskip}
    \begin{mathpar}
    \inferrule{
      \type{\Gamma}{d}{\sigma} \\
      \type{\Gamma}{\sigma}{U} \\
      \type{\Gamma}{\tau}{U} \\
      \subtype{\Gamma}{\sigma}{\tau}
    }{
      \type{\Gamma}{e}{\tau}
    }
    \end{mathpar}
    Induction hypothesis: there are derivations $\mathcal{D}_i$ ending in $\mathcal{J}_i$
    such that $\mathcal{R}$ builds a derivation ending in $\type{\Gamma}{e}{\sigma'}$
    and $\subtype{\Gamma}{\sigma'}{\sigma}$ holds. \\
    The desired derivations are $\mathcal{D}_i$, and $\subtype{\Gamma}{\sigma'}{\tau}$
    holds by \nameref{thm:transivity-subtyping}. \qedhere
\end{itemize}
\end{proof}

\subsection{Regularity}

\emph{Regularity}\index{regularity}
states that the types of typing judgements are themselves well-typed.
Proving this requires the substitutivity lemmas as well as a few inversion principles.

\begin{lemma} \label{lem:wf-subsize}
If $\subsize{\Phi}{r}{s}$ then $\wf{\Phi}{r}$ and $\wf{\Phi}{s}$.
\end{lemma}

\begin{proof}
By induction on the derivation of $\subsize{\Phi}{r}{s}$.
\end{proof}

\begin{lemma} \label{lem:typed-env}
If $\wf{\Phi}{\Gamma}$ and $(\annot{x}{\tau}) \in \Gamma$
then $\type{\Phi; \Gamma}{\tau}{U}$ for some $U$.
\end{lemma}
\begin{proof}
By induction on the derivation of $\wf{\Phi}{\Gamma}$.
For \rref{cons-ass}, if the variable is $x$, the typing premise is the desired typing judgement.
\end{proof}

\begin{lemma} \label{lem:wf-env}
If $\type{\Phi; \Gamma}{e}{\tau}$ then $\wf{\Phi}{\Gamma}$.
\end{lemma}
\begin{proof}
By induction on the derivation of $\type{\Phi; \Gamma}{e}{\tau}$.
\end{proof}

\begin{theorem}[Regularity] \label{thm:regularity}
If $\type{\Phi; \Gamma}{e}{\tau}$ then $\type{\Phi; \Gamma}{\tau}{U}$.
\end{theorem}

\begin{proof}
By induction on the derivation of $\type{\Phi; \Gamma}{e}{\tau}$.
\begin{itemize}[noitemsep, label=\textbf{Case}, leftmargin=*, labelindent=\parindent]
  \item \rref*{conv}. Trivial.
  \item \rref*{var}. By \cref{lem:typed-env}.
  \item[\textbf{Cases}] \rref*{univ}, \rref*{pi}, \rref*{forall}, \rref*{forall<}, \rref*{nat}, \rref*{wft}.
    By \rref{univ}, using \cref{lem:wf-env} when needed.
  \item[\textbf{Cases}] \rref*{lam}, \rref*{slam}, \rref*{slam<}.
    By \rref{pi, forall, forall<} respectively,
    using the induction hypothesis as premise.
  \item[\textbf{Cases}] \rref*{zero}, \rref*{succ}, \rref*{sup}.
    By \rref{nat, nat, wft} respectively,
    using \cref{lem:wf-subsize} to get a size judgement from the subsizing premise.
  \item \rref*{app}.
    \vspace{-\baselineskip}
    \begin{mathpar}
      \inferrule{
        \infer{\Phi; \Gamma}{e_1}{\funtype{x}{\sigma}{\tau}} \\
        \check{\Phi; \Gamma}{e_2}{\sigma}
      }{
        \infer{\Phi; \Gamma}{\app{e_1}{e_2}}{\subst{\tau}{x}{e_1}}
      }
    \end{mathpar}
    By the induction hypothesis, $\funtype{x}{\sigma}{\tau}$ is well typed with some universe $U$.
    By \nameref{thm:inversion} on \rref{pi},
    we have that $\type{\Phi; \Gamma, \annot{x}{\sigma}}{\tau}{U'}$ for some $U'$.
    By \nameref{lem:substitutivity-terms}, we conclude that $\type{\Phi; \Gamma}{\subst{\tau}{x}{e_1}}{U'}$.
  \item[\textbf{Cases}] \rref*{case-nat}, \rref*{case-wft}.
    \vspace{-\baselineskip}
    \begin{mathpar}
      \inferrule{
        \type{\Phi; \Gamma}{e}{\N{s}} \\
        \type{\Phi; \Gamma, \annot{x}{\N{s}}}{P}{U} \\
        \seq
      }{
        \infer{\Phi; \Gamma}{\match{e}{\fun*{x}{P}}{\any \any}}{\subst{P}{x}{e}}
      }
      \and
      \inferrule{
        \type{\Phi; \Gamma}{e}{\W{x}{\sigma}{\tau}{s}} \\
        \type{\Phi; \Gamma, \annot{x}{\W{x}{\sigma}{\tau}{s}}}{P}{U} \\
        \seq
      }{
        \infer{\Phi; \Gamma}{\match{e}{\fun*{x}{P}}{\any}}{\subst{P}{x}{e}}
      }
    \end{mathpar}
    By \nameref{lem:substitutivity-terms} of $e$ in $P$.
  \item[\textbf{Cases}] \rref*{sapp}, \rref*{sapp<}.
    By the same argument as for case \rref*{app},
    using instead inversion on \rref{forall, forall<} respectively,
    followed by \nameref{lem:substitutivity-unbounded} and \nameref{lem:substitutivity-bounded} respectively.
  \item \rref*{fix}. By \rref{forall} on the first premise. \qedhere
\end{itemize}
\end{proof}

\subsection{Subject reduction}

The final metatheoretical property required is \emph{subject reduction}\index{subject reduction},
which states that what a well-typed term reduces to is also well-typed with the same type.
The proof requires using the replacement lemmas.

\begin{lemma} \label{lem:wf-defs}
If $\wf{\Phi}{\Gamma}$ and $(\define{x}{\tau}{e}) \in \Gamma$ then $\type{\Gamma}{e}{\tau}$.
\end{lemma}
\begin{proof}
By induction on the derivation of $\wf{\Phi}{\Gamma}$,
using the typing premise of \rref{cons-def} when the variable is $x$.
\end{proof}

\begin{lemma} \label{lem:sr}
If $\type{\Phi; \Gamma}{e}{\tau}$ and $\red{\Phi; \Gamma}{e}{e'}$ then $\type{\Phi; \Gamma}{e'}{\tau}$.
\end{lemma}

\begin{proof}
By cases on the derivation of $\red{\Phi; \Gamma}{e}{e'}$ and \nameref{thm:inversion} of the right-hand term.
The case for $\delta$-reduction follows by \cref{lem:wf-env,lem:wf-defs}.
The remaining cases are all similar to one another;
I cover only $\beta$-reduction for the application of bounded sizes here.
\vspace{-\baselineskip}
\begin{mathpar}
\inferrule{~}{
  \red{\Phi; \Gamma}{\App{(\Fun<{\alpha}{r}{e})}{s}}{\subst{e}{\alpha}{s}}
}
\end{mathpar}
By inversion on \rref{sapp<}, we have
\begin{itemize}[noitemsep]
  \item $\type{\Phi; \Gamma}{\Fun<{\alpha}{r}{e}}{\Funtype<{\alpha}{r}{\sigma}}$,
  \item $\subsize{\Phi}{\sss{s}}{r}$, and
  \item $\subtype{\Phi; \Gamma}{\subst{\sigma}{\alpha}{s}}{\tau}$.
\end{itemize}
By inversion again on \rref{slam}, we have
\begin{itemize}[noitemsep]
  \item $\wf{\Phi}{s}$,
  \item $\type{\Phi, \bound{\alpha}{s}; \Gamma}{e}{\sigma'}$, and
  \item $\subtype{\Phi; \Gamma}{\Funtype<{\alpha}{s}{\sigma'}}{\Funtype<{\alpha}{s}{\sigma}}$.
\end{itemize}
By inversion on subtyping, $\alpha$-cumulativity, and closure of reduction,
we also have $\subtype{\Phi, \bound{\alpha}{s}; \Gamma}{\sigma'}{\sigma}$.
% TODO: please don't make me explicitly list the inversion principles
By \nameref{lem:substitutivity-bounded}, we have
\begin{itemize}[noitemsep]
  \item $\subtype{\Phi; \Gamma}{\subst{\sigma'}{\alpha}{s}}{\subst{\sigma}{\alpha}{s}}$ and
  \item $\type{\Phi; \Gamma}{\subst{e}{\alpha}{s}}{\subst{\sigma'}{\alpha}{s}}$.
\end{itemize}
By \nameref{thm:transivity-subtyping} and \nameref{thm:regularity}, we have
\begin{itemize}[noitemsep]
  \item $\subtype{\Phi; \Gamma}{\subst{\sigma'}{\alpha}{s}}{\tau}$,
  \item $\type{\Phi; \Gamma}{\subst{\sigma'}{\alpha}{s}}{U_1}$, and
  \item $\type{\Phi; \Gamma}{\tau}{U_2}$.
\end{itemize}
By \rref{conv}, both $\subst{\sigma'}{\alpha}{s}$ and $\tau$ have type $\rules{U_1}{U_2}$.
Finally, by \rref{conv} again, we have $\type{\Phi; \Gamma}{\subst{e}{\alpha}{s}}{\tau}$.
\end{proof}

\begin{theorem}[Subject reduction]\label{thm:subject-reduction}
If $\type{\Phi; \Gamma}{e}{\tau}$ and $\red*{\Phi; \Gamma}{e}{e'}$ then $\type{\Phi; \Gamma}{e'}{\tau}$.
\end{theorem}

\begin{proof}
By induction on the derivation of $\red*{\Phi; \Gamma}{e}{e'}$.
\begin{itemize}[noitemsep, label=\textbf{Case}, leftmargin=*, labelindent=\parindent]
  \item \rref*{red*-once}. By \cref{lem:sr}.
  \item \rref*{red*-refl}. Trivial.
  \item \rref*{red*-trans}. By the induction hypothesis on the first premise we have
    $\type{\Phi; \Gamma}{e_2}{\tau}$;
    by the induction hypothesis again on the second premise we have
    $\type{\Phi; \Gamma}{e_3}{\tau}$.
  \item \rref*{red*-cong}. The various congruence cases are all similar to one another;
    I cover only the case of \rref*{let} as example.
    \begin{mathpar}
      \inferrule{
        \red*{\Phi; \Gamma}{\sigma}{\sigma'} \\
        \red*{\Phi; \Gamma}{e_1}{e'_1} \\
        \red*{\Phi; \Gamma, \define{x}{\sigma'}{e'_1}}{e_2}{e'_2}
      }{
        \red*{\Phi; \Gamma}{\letin{x}{\sigma}{e_1}{e_2}}{\letin{x}{\sigma'}{e'_1}{e'_2}}
      }
    \end{mathpar}
    By \nameref{thm:inversion} on \rref{let}, we have
    \begin{itemize}[noitemsep]
      \item $\type{\Phi; \Gamma}{\sigma}{U}$,
      \item $\type{\Phi; \Gamma}{e_1}{\sigma}$,
      \item $\type{\Phi; \Gamma, \define{x}{\sigma}{e_1}}{e_2}{\tau'}$, and
      \item $\subtype{\Phi; \Gamma}{\subst{\tau'}{x}{e_1}}{\tau}$.
    \end{itemize}
    By \rref{red*-refl, red*-cong, acum-refl, subtype-red} and
    \nameref{thm:transivity-subtyping}, we have
    \begin{itemize}[noitemsep]
      \item $\subtype{\Phi; \Gamma}{\sigma'}{\sigma}$,
      \item $\subtype{\Phi; \Gamma}{\subst{\tau'}{x}{e'_1}}{\subst{\tau'}{x}{e_1}}$, and
      \item $\subtype{\Phi; \Gamma}{\subst{\tau'}{x}{e'_1}}{\tau}$.
    \end{itemize}
    Then by \nameref{lem:replacement-subtyping} and by \nameref{lem:replacement-reduction},
    we have $\type{\Phi; \Gamma, \define{x}{\sigma'}{e'_1}}{e_2}{\tau'}$.
    The induction hypotheses then give
    \begin{itemize}[noitemsep]
      \item $\type{\Phi; \Gamma}{\sigma'}{U}$,
      \item $\type{\Phi; \Gamma}{e'_1}{\sigma}$, and
      \item $\type{\Phi; \Gamma, \define{x}{\sigma'}{e'_1}}{e'_2}{\tau'}$.
    \end{itemize}
    By \nameref{thm:regularity} and \nameref{lem:substitutivity-terms}, we have
    \begin{itemize}[noitemsep]
      \item $\type{\Phi; \Gamma}{\tau}{U_1}$,
      \item $\type{\Phi; \Gamma, \define{x}{\sigma'}{e'_1}}{\tau'}{U_2}$, and
      \item $\type{\Phi; \Gamma}{\subst{\tau'}{x}{e'_1}}{U_2}$.
    \end{itemize}
    By \rref{conv}, both $\tau$ and $\subst{\tau'}{x}{e'_1}$ have type $\rules{U_1}{U_2}$.
    Finally, by \rref{let} and by \rref{conv} again,
    we have $\type{\Phi; \Gamma}{\letin{x}{\sigma'}{e'_1}{e'_2}}{\tau}$. \qedhere
\end{itemize}
\end{proof}

\section{Metatheory of \CICE}

Fewer metatheoretical properties of \CICE are required for the type preservation proof,
namely substitutivity\index{substitutivity},
the inversion principles\index{inversion principle},
and subject equivalence\index{subject reduction}.
I don't provide the proofs here, as the properties of CIC,
typed equivalence, and equality reflection are well established,
and they're similar to the proofs for the analogous lemmas for \lang.

\begin{lemma}[Substitutivity]
Suppose $\type{\GammaT_1}{\eT}{\sigmaT}$.
\begin{itemize}[noitemsep]
  \item If $\type{\GammaT_1, \annot{\xT}{\sigmaT}, \GammaT_2}{\eT'}{\tauT}$ then $\type{\GammaT_1, \subst{\GammaT_2}{\xT}{\eT}}{\subst{\eT'}{\xT}{\eT}}{\subst{\xT}{\tauT}{\eT}}$.
  \item If $\subtype{\GammaT_1, \annot{\xT}{\sigmaT}, \GammaT_2}{\tauT_1}{\tauT_2}$ then $\type{\GammaT_1, \subst{\GammaT_2}{\xT}{\eT}}{\subst{\tauT_1}{\xT}{\eT}}{\subst{\tauT_2}{\tauT}{\eT}}$.
  \item If $\defeq{\GammaT_1, \annot{\xT}{\sigmaT}, \GammaT_2}{\eT_1}{\eT_2}{\tauT}$ then $\defeq{\GammaT_1, \subst{\GammaT_2}{\xT}{\eT}}{\subst{\eT_1}{\xT}{\eT}}{\subst{\eT_2}{\tauT}{\eT}}{\subst{\tauT}{\xT}{\eT}}$.
\end{itemize}
\end{lemma}

\begin{theorem}[Inversion]
Given a syntactic form $\eT$ and a typing rule $\mathcal{R} \neq \text{\upshape \rref*{conv*}}$ for that form,
if $\mathcal{D}$ is a derivation ending in $\type{\GammaT}{\eT}{\tauT}$
and $\mathcal{J}_i$ are the judgement forms in the premises of $\mathcal{R}$,
then there exist derivations $\mathcal{D}_i$ ending in $\mathcal{J}_i$
such that $\mathcal{R}$ builds a derivation ending in $\type{\GammaT}{\eT}{\sigmaT}$,
and $\subtype{\GammaT}{\sigmaT}{\tauT}$ holds.
\end{theorem}

\iffalse
\begin{proof}
By induction on the derivation of $\type{\GammaT}{\eT}{\tauT}$.
\begin{itemize}[noitemsep, label=\textbf{Case}, leftmargin=*, labelindent=\parindent]
  \item $\mathcal{R}$. The premises of the derivation are the desired ones,
    building a derivation ending in $\type{\GammaT}{\eT}{\tauT}$,
    and $\subtype{\GammaT}{\tauT}{\tauT}$ holds by well-typedness of $\tauT$,
    \rref{equiv-refl}, and \rref{subtype-conv}.
  \item \rref*{conv*}.
    \vspace{-\baselineskip}
    \begin{mathpar}
    \inferrule{
      \type{\GammaT}{\eT}{\sigmaT} \\
      \type{\GammaT}{\sigmaT}{\UT} \\
      \type{\GammaT}{\tauT}{\UT} \\
      \subtype{\GammaT}{\sigmaT}{\tauT}
    }{
      \type{\GammaT}{\eT}{\tauT}
    }
    \end{mathpar}
    Induction hypothesis: there are derivations $\mathcal{D}_i$ ending in $\mathcal{J}_i$
    such that $\mathcal{R}$ builds a derivation ending in $\type{\GammaT}{\eT}{\sigmaT'}$
    and $\subtype{\GammaT}{\sigmaT'}{\sigmaT}$ holds. \\
    The desired derivations are $\mathcal{D}_i$, and $\subtype{\GammaT}{\sigmaT'}{\tauT}$
    holds by \rref{subtype-trans}.
\end{itemize}
\end{proof}
\fi

\begin{theorem}[Subject equivalence]\label{thm:subject-equivalence}
If $\defeq{\GammaT}{\eT_1}{\eT_2}{\tauT}$
then $\type{\GammaT}{\eT_1}{\tauT}$ and $\type{\GammaT}{\eT_2}{\tauT}$.
\end{theorem}

For completeness I restate the consistency of \CICE, again as a postulate.

\begin{postulate}[Consistency]
There exists no term $\eT$ such that
$\type{\mt}{\eT}{\funtypeT{\PT}{\PropT}{\PT}}$.
\end{postulate}

\section{Proof of Type Preservation}

As was outlined in \cref{sec:syntactic-model},
the proof of type preservation involves an additional five lemmas
demonstrating that the translation respects substitution, reduction,
$\alpha$-cumulativity, the closure of reduction, subtyping, and typing itself.
These lemmas require further sublemmas;
the subsequent subsections group the sublemmas with their lemma or theorem.

Many of these lemmas make use of the translation of terms $e$ and term environments $\Gamma$
using the shorthand $\compile{e}$ and $\compile{\Gamma}$.
If not specified, the well-formedness of $\Gamma$ and well-typedness of $e$
needed for the translations are derived when possible
(\eg $\wf{\Phi}{\Gamma}$ and $\type{\Phi; \Gamma}{\tau}{U}$ from $\type{\Phi; \Gamma}{e}{\tau}$
by \cref{lem:wf-env} and \nameref{thm:regularity}, respectively)
and otherwise assumed as hypotheses.

\subsection{Compositionality}

\subsection{Preservation of reduction}

\subsection{Preservation of \texorpdfstring{$\alpha$}{alpha}-cumulativity}

This lemma is proven independently of compositionality and preservation of reduction.
Like preservation of reduction, the well-typedness of the translation of the $\alpha$-cumulative terms
is required to derive various equivalences,
but their types need not even be the same,
since the \CICE subtyping judgement itself is untyped.

\begin{lemma}[Preservation of $\alpha$-cumulativity]\label{lem:pres-acum}
Suppose we have the following:
\begin{itemize}[noitemsep]
  \item $\acum{\tau_1}{\tau_2}$,
  \item $\type{\Phi; \Gamma}{\tau_1}{U_1}$,
  \item $\type{\Phi; \Gamma}{\tau_2}{U_2}$,
  \item $\type{\compile{\Phi}\compile{\Gamma}}{\compile{\tau_1}}{\UT_1}$, and
  \item $\type{\compile{\Phi}\compile{\Gamma}}{\compile{\tau_2}}{\UT_2}$.
\end{itemize}
Then $\subtype{\compile{\Phi}\compile{\Gamma}}{\compile{\tau_1}}{\compile{\tau_2}}$.
\end{lemma}

\begin{proof}
By induction on the derivation of $\acum{\tau_1}{\tau_2}$.
\begin{itemize}[noitemsep, label=\textbf{Case}, leftmargin=*, labelindent=\parindent]
  \item \rref*{acum-refl}.
    Trivial by \rref{equiv-refl, subtype-conv} using well-typedness of the translated term.
  \item[\textbf{Cases}] \rref*{acum-prop}, \rref*{acum-type}.
    Trivial by \rref{subtype-prop} and \rref{subtype-type}, respectively.
  \item \rref{acum-pi}.
    \vspace{-\baselineskip}
    \begin{mathpar}
    \inferrule{
      \acum{\tau_1}{\tau_2}
    }{
      \acum{\funtype{x}{\sigma}{\tau_1}}{\funtype{x}{\sigma}{\tau_2}}
    }
    \end{mathpar}
    By inversion on $\type{\Phi; \Gamma}{\funtype{x}{\sigma}{\tau_i}}{U_i}$ and on
    $\type{\compile{\Phi}\compile{\Gamma}}{\funtypeT{\xT}{\compile{\sigma}}{\compile{\tau_i}_{\annot{x}{\sigma}}}}{\compile{U_i}}$
    for $i = 1, 2$, omitting unneeded judgements, we have
    \begin{itemize}[noitemsep]
      %\item $\type{\Phi; \Gamma}{\sigma}{U'}$,
      \item $\type{\Phi; \Gamma, \annot{x}{\sigma}}{\tau_i}{U''_i}$,
      %\item $\subtype{\Phi; \Gamma}{\rules{U'}{U''_i}}{U'_i}$,
      \item $\type{\compile{\Phi}\compile{\Gamma}}{\compile{\sigma}}{\UT'}$, and
      \item $\type{\compile{\Phi}\compile{\Gamma}, \annotT{\xT}{\compile{\sigma}}}{\compile{\tau_i}_{\annot{x}{\sigma}}}{\UT''_i}$.
      %\item $\subtype{\compile{\Phi}\compile{\Gamma}}{\rules{\UT'}{\UT''_i}}{\UT_i}$.
    \end{itemize}
    By the induction hypothesis on the premise using the above, we have
    $\subtype{\compile{\Phi}\compile{\Gamma}, \annotT{\xT}{\compile{\sigma}}}{\compile{\tau_1}_{\annot{x}{\sigma}}}{\compile{\tau_2}_{\annot{x}{\sigma}}}$.
    By \rref{equiv-refl}, we have $\defeq{\compile{\Phi}\compile{\Gamma}}{\compile{\sigma}}{\compile{\sigma}}{\UT'}$.
    Then by \rref{subtype-pi}, we have
    $\subtype{\compile{\Phi}\compile{\Gamma}}{\funtypeT{\xT}{\compile{\sigma}}{\compile{\tau_1}_{\annot{x}{\sigma}}}}{\funtypeT{\xT}{\compile{\sigma}}{\compile{\tau_2}_{\annot{x}{\sigma}}}}$.
  \item \rref{acum-forall}.
    \vspace{-\baselineskip}
    \begin{mathpar}
    \inferrule{
      \acum{\tau_1}{\tau_2}
    }{
      \acum{\Funtype{\alpha}{\tau_1}}{\Funtype{\alpha}{\tau_2}}
    }
    \end{mathpar}
    By inversion on $\type{\Phi; \Gamma}{\Funtype{\alpha}{\tau_i}}{U_i}$ and on
    $\type{\compile{\Phi}\compile{\Gamma}}{\funtypeT{\alphaT}{\SizeT}{\compile{\tau_i}_{\alpha}}}{\UT_i}$
    for $i = 1, 2$, omitting unneeded judgements, we have
    \begin{itemize}[noitemsep]
      \item $\type{\Phi, \alpha; \Gamma}{\tau_i}{U''_i}$,
      \item $\type{\compile{\Phi}\compile{\Gamma}}{\SizeT}{\UT'}$, and
      \item $\type{\compile{\Phi}\compile{\Gamma}, \annotT{\alphaT}{\SizeT}}{\compile{\tau_i}_{\alpha}}{\UT''_i}$.
    \end{itemize}
    By the induction hypothesis on the premise using the above, we have
    $\subtype{\compile{\Phi}\compile{\Gamma}, \annotT{\alphaT}{\SizeT}}{\compile{\tau_1}_{\alpha}}{\compile{\tau_2}_{\alpha}}$.
    By \rref{equiv-refl}, we have $\defeq{\compile{\Phi}\compile{\Gamma}}{\SizeT}{\SizeT}{\UT'}$.
    Then by \rref{subtype-pi}, we have
    $\subtype{\compile{\Phi}\compile{\Gamma}}{\funtypeT{\alphaT}{\SizeT}{\compile{\tau_1}_{\alpha}}}{\funtypeT{\alphaT}{\SizeT}{\compile{\tau_2}_{\alpha}}}$.
  \item \rref{acum-forall<}.
    \vspace{-\baselineskip}
    \begin{mathpar}
    \inferrule{
      \acum{\tau_1}{\tau_2}
    }{
      \acum{\Funtype<{\alpha}{s}{\tau_1}}{\Funtype<{\alpha}{s}{\tau_2}}
    }
    \end{mathpar}
    By inversion on $\type{\Phi; \Gamma}{\Funtype<{\alpha}{s}{\tau_i}}{U_i}$ and on
    $\type{\compile{\Phi}\compile{\Gamma}}{\funtypeT{\alphaT}{\SizeT}{\funtypeT{\alphaT^*}{\alphaT \szltT \compile{s}}{\compile{\tau_i}_{\bound{\alpha}{s}}}}}{\UT_i}$
    for $i = 1, 2$, omitting unneeded judgements, we have
    \begin{itemize}[noitemsep]
      \item $\type{\Phi; \Gamma, \bound{\alpha}{s}}{\tau_i}{U''_I}$,
      \item $\type{\compile{\Phi}\compile{\Gamma}}{\SizeT}{\UT'}$,
      \item $\type{\compile{\Phi}\compile{\Gamma}, \annotT{\alphaT}{\SizeT}}{\alphaT \szltT \compile{s}}{\UT''}$, and
      \item $\type{\compile{\Phi}\compile{\Gamma}, \annotT{\alphaT}{\SizeT}, \annotT{\alphaT^*}{\alphaT \szltT \compile{s}}}{\compile{\tau_i}_{\bound{\alpha}{s}}}{\UT'''_i}$.
    \end{itemize}
    By the induction hypothesis on the premise using the above, we have
    $\subtype{\compile{\Phi}\compile{\Gamma}, \annotT{\alphaT}{\SizeT}, \annotT{\alphaT^*}{\alphaT \szltT \compile{s}}}{\compile{\tau_1}_{\bound{\alpha}{s}}}{\compile{\tau_2}_{\bound{\alpha}{s}}}$.
    By \rref{equiv-refl}, we have $\defeq{\compile{\Phi}\compile{\Gamma}}{\SizeT}{\SizeT}{\UT'}$
    and $\defeq{\compile{\Phi}\compile{\Gamma}, \annotT{\alphaT}{\SizeT}}{\alphaT \szltT \compile{s}}{\alphaT \szltT \compile{s}}{\UT''}$.
    Then by \rref{subtype-pi} twice, we have $\subtype{\compile{\Phi}\compile{\Gamma}}{\funtypeT{\alphaT}{\SizeT}{\funtypeT{\alphaT^*}{\alphaT \szltT \compile{s}}{\compile{\tau_1}_{\bound{\alpha}{s}}}}}{\funtypeT{\alphaT}{\SizeT}{\funtypeT{\alphaT^*}{\alphaT \szltT \compile{s}}{\compile{\tau_2}_{\bound{\alpha}{s}}}}}$.
    \qedhere
\end{itemize}
\end{proof}

\subsection{Preservation of closure of reduction}

\hyperref[lem:pres-red*]{Preservation of closure of reduction},
\nameref{lem:pres-subtyping}, and
\nameref{thm:pres-typing}
are proven by mutual structural induction,
but for clarity are stated separately.
This means that each lemma or theorem is proven by induction on the relevant derivation,
but we can appeal to the other lemmas or theorem when applied \emph{only} to a subderivation.
This guarantees that we aren't using circular reasoning, since derivations are finite.
In this case, \nameref{thm:pres-typing} appeals to \nameref{lem:pres-subtyping}
in the \rref*{conv} case with the subtyping premise, and
\nameref{lem:pres-subtyping} appeals to \hyperref[lem:pres-red*]{Preservation of closure of reduction}
with its reduction premises.
\hyperref[lem:pres-red*]{Preservation of closure of reduction} is proven by induction on both a reduction derivation
and on a typing derivation, and appeals to \nameref{thm:pres-typing} only with typing premises.

\begin{lemma}[Preservation of reflexive, transitive, congruent closure of reduction]\label{lem:pres-red*}
Suppose we have the following:
\begin{itemize}[noitemsep]
  \item $\red*{\Phi; \Gamma}{e}{e'}$ and
  \item $\type{\Phi; \Gamma}{e}{\tau}$.
\end{itemize}
Then $\defeq{\compile{\Phi}\compile{\Gamma}}{\compile{e}}{\compile{e'}}{\compile{\tau}}$,
where \nameref{thm:subject-reduction} gives us $\type{\Phi; \Gamma}{e'}{\tau}$
in order to translate $\compile{e'}$.
\end{lemma}

\begin{proof}

\end{proof}

\subsection{Preservation of subtyping}

Most of the heavy lifting in proving preservation of subtyping is done by
preservation of $\alpha$-cumulativity and preservation of the closure of reduction.
Use of preservation of the closure of reduction is justified because it's applied only
to a direct subderivation of the subtyping derivation.
This lemma, too, requires that the translation of the subtyped terms specifically is type-preserving.

\begin{lemma}[Preservation of subtyping]\label{lem:pres-subtyping}
Suppose we have the following:
\begin{itemize}[noitemsep]
  \item $\subtype{\Phi; \Gamma}{\tau_1}{\tau_2}$,
  \item $\type{\Phi; \Gamma}{\tau_1}{U}$,
  \item $\type{\Phi; \Gamma}{\tau_2}{U}$,
  \item $\type{\compile{\Phi}\compile{\Gamma}}{\compile{\tau_1}}{\compile{U}}$, and
  \item $\type{\compile{\Phi}\compile{\Gamma}}{\compile{\tau_2}}{\compile{U}}$.
\end{itemize}
Then $\subtype{\compile{\Phi}\compile{\Gamma}}{\compile{\tau_1}}{\compile{\tau_2}}$.
\end{lemma}

\begin{proof}
By cases on the derivation of $\subtype{\Phi; \Gamma}{\tau_1}{\tau_2}$,
there being only one case.
\begin{mathpar}
\inferrule{
  \red*{\Phi; \Gamma}{\tau_1}{\sigma_1} \\
  \red*{\Phi; \Gamma}{\tau_2}{\sigma_2} \\
  \acum{\sigma_1}{\sigma_2}
}{
  \subtype{\Phi; \Gamma}{\tau_1}{\tau_2}
}
\end{mathpar}
By \hyperref[lem:pres-red*]{Preservation of closure of reduction} on the first two premises, we have
\begin{itemize}[noitemsep]
  \item $\defeq{\compile{\Phi}\compile{\Gamma}}{\compile{\tau_1}}{\compile{\sigma_1}}{\compile{U}}$ and
  \item $\defeq{\compile{\Phi}\compile{\Gamma}}{\compile{\tau_2}}{\compile{\sigma_2}}{\compile{U}}$.
\end{itemize}
By \nameref{thm:subject-reduction} and \nameref{thm:subject-equivalence}, we have
\begin{itemize}[noitemsep]
  \item $\type{\Phi; \Gamma}{\sigma_1}{U}$,
  \item $\type{\Phi; \Gamma}{\sigma_2}{U}$,
  \item $\type{\compile{\Phi}\compile{\Gamma}}{\compile{\sigma_1}}{\compile{U}}$, and
  \item $\type{\compile{\Phi}\compile{\Gamma}}{\compile{\sigma_2}}{\compile{U}}$.
\end{itemize}
Using the above and the final premise, by \nameref{lem:pres-acum}, we have
$\subtype{\compile{\Phi}\compile{\Gamma}}{\compile{\sigma_1}}{\compile{\sigma_2}}$.
Then by \rref{equiv-sym, subtype-conv, subtype-trans}, we have
$\subtype{\compile{\Phi}\compile{\Gamma}}{\compile{\tau_1}}{\compile{\tau_2}}$.
\end{proof}

\subsection{Type preservation}

\label{thm:pres-typing}