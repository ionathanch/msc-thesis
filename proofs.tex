\chapter{Metatheory and Type Preservation}

In this section, I elaborate on the proofs of the lemmas and theorems listed in \cref{sec:syntactic-model},
culminating in type preservation, which by \cref{thm:consistency} proves the consistency of \lang.
Prior to these proofs, I provide the required metatheoretical properties of both \lang and \CICE.

\section{Metatheory of \CICE}

The first three lemmas, which \citet{ECC} names \emph{weakening},
\emph{context replacement}, and \emph{cut},
are well-established properties, so I don't prove them here.
See \opcit for instance for details on the proof structure.

\begin{lemma}[Weakening]
Let $\GammaT$ and $\GammaT'$ be term environments where $\GammaT'$ does not shadow any variables of $\GammaT$,
and suppose that $\wf{}{\GammaT, \GammaT'}$.
\begin{itemize}[noitemsep]
  \item If $\type{\GammaT}{\eT}{\tauT}$ then $\type{\GammaT, \GammaT'}{\eT}{\tauT}$.
  \item If $\subtype{\GammaT}{\tauT_1}{\tauT_2}$ then $\subtype{\GammaT, \GammaT'}{\tauT_1}{\tauT_2}$.
  \item If $\defeq{\GammaT}{\eT_1}{\eT_2}{\tauT}$ then $\defeq{\GammaT, \GammaT'}{\eT_1}{\eT_2}{\tauT}$.
\end{itemize}
\end{lemma}

\begin{lemma}[Context replacement]
Suppose $\subtype{\GammaT_1}{\sigmaT_1}{\sigmaT_2}$.
\begin{itemize}[noitemsep]
  \item If $\type{\GammaT_1, \annotT{\xT}{\sigmaT_2}, \GammaT_2}{\eT}{\tauT}$ then $\type{\GammaT_1, \annotT{\xT}{\sigmaT_1}, \GammaT_2}{\eT}{\tauT}$.
  \item If $\subtype{\GammaT_1, \annotT{\xT}{\sigmaT_2}, \GammaT_2}{\tauT_1}{\tauT_2}$ then $\subtype{\GammaT_1, \annotT{\xT}{\sigmaT_1}, \GammaT_2}{\tauT_1}{\tauT_2}$.
  \item If $\defeq{\GammaT_1, \annotT{\xT}{\sigmaT_2}, \GammaT_2}{\eT_1}{\eT_2}{\tauT}$ then $\defeq{\GammaT_1, \annotT{\xT}{\sigmaT_1}, \GammaT_2}{\eT_1}{\eT_2}{\tauT}$.
\end{itemize}
\end{lemma}

\begin{lemma}[Cut]
Suppose $\type{\GammaT_1}{\eT}{\sigmaT}$.
\begin{itemize}[noitemsep]
  \item If $\type{\GammaT_1, \annot{\xT}{\sigmaT}, \GammaT_2}{\eT'}{\tauT}$ then $\type{\GammaT_1, \subst{\GammaT_2}{\xT}{\eT}}{\subst{\eT'}{\xT}{\eT}}{\subst{\xT}{\tauT}{\eT}}$.
  \item If $\subtype{\GammaT_1, \annot{\xT}{\sigmaT}, \GammaT_2}{\tauT_1}{\tauT_2}$ then $\type{\GammaT_1, \subst{\GammaT_2}{\xT}{\eT}}{\subst{\tauT_1}{\xT}{\eT}}{\subst{\tauT_2}{\tauT}{\eT}}$.
  \item If $\defeq{\GammaT_1, \annot{\xT}{\sigmaT}, \GammaT_2}{\eT_1}{\eT_2}{\tauT}$ then $\defeq{\GammaT_1, \subst{\GammaT_2}{\xT}{\eT}}{\subst{\eT_1}{\xT}{\eT}}{\subst{\eT_2}{\tauT}{\eT}}{\subst{\tauT}{\xT}{\eT}}$.
\end{itemize}
\end{lemma}

The well-typedness of types in typing and well-formedness judgements can then be proven.
I again omit the proof and defer to \opcit for further details.

\begin{lemma} \hfill
\begin{itemize}[noitemsep]
  \item If $\type{\GammaT}{\eT}{\tauT}$ then $\type{\GammaT}{\tauT}{\UT}$ for some $\UT$.
  \item If $\wf{}{\GammaT}$ and $(\annot{\xT}{\tauT}) \in \GammaT$ then $\type{\GammaT}{\tauT}{\UT}$ for some $\UT$.
\end{itemize}
\end{lemma}

The remaining properties we need are inversion principles,
which allow for deducing the necessary premises for a typing derivation,
with one principle for each syntactic form.
In the presence of subtyping, these principles are a little more complex,
relating the type derived from the premises to the desired type by a subtyping judgement.
For concision, I prove all inversion principles for a general typing rule
rather than handling each rule explicitly.
When proving by induction or by cases,
I omit all impossible cases.

\begin{lemma}[Inversion]
Given a syntactic form $\eT$ and a typing rule $\mathcal{R} \neq \text{\upshape \rref*{conv*}}$ for that form,
if $\mathcal{D}$ is a derivation ending in $\type{\GammaT}{\eT}{\tauT}$
and $\mathcal{J}_i$ are the judgement forms in the premises of $\mathcal{R}$,
then there exist derivations $\mathcal{D}_i$ ending in $\mathcal{J}_i$
such that $\mathcal{R}$ builds a derivation ending in $\type{\GammaT}{\eT}{\sigmaT}$,
and $\subtype{\GammaT}{\sigmaT}{\tauT}$ holds.
\end{lemma}
\begin{proof}
By induction on the derivation of $\type{\GammaT}{\eT}{\tauT}$.
\begin{itemize}[noitemsep, label=\textbf{Case}, leftmargin=*, labelindent=\parindent]
  \item $\mathcal{R}$. The premises of the derivation are the desired ones,
    building a derivation ending in $\type{\GammaT}{\eT}{\tauT}$,
    and $\subtype{\GammaT}{\tauT}{\tauT}$ holds by well-typedness of $\tauT$,
    \rref{equiv-refl}, and \rref{subtype-conv}.
  \item \rref*{conv*}.
    \vspace{-\baselineskip}
    \begin{mathpar}
    \inferrule{
      \type{\GammaT}{\eT}{\sigmaT} \\
      \type{\GammaT}{\sigmaT}{\UT} \\
      \type{\GammaT}{\tauT}{\UT} \\
      \subtype{\GammaT}{\sigmaT}{\tauT}
    }{
      \type{\GammaT}{\eT}{\tauT}
    }
    \end{mathpar}
    Induction hypothesis: there are derivations $\mathcal{D}_i$ ending in $\mathcal{J}_i$
    such that $\mathcal{R}$ builds a derivation ending in $\type{\GammaT}{\eT}{\sigmaT'}$
    and $\subtype{\GammaT}{\sigmaT'}{\sigmaT}$ holds. \\
    The desired derivations are $\mathcal{D}_i$, and $\subtype{\GammaT}{\sigmaT'}{\tauT}$
    holds by \rref{subtype-trans}.
\end{itemize}
\end{proof}

\section{Metatheory of \lang}

\section{Proof of Type Preservation}